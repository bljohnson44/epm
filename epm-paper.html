<HTML>
<HEAD>
	<TITLE>Software Distribution Using the ESP Package Manager</TITLE>
	<META NAME="Author" CONTENT="Michael Sweet">
	<META NAME="Copyright" CONTENT="Copyright 1999-2000 by Easy Software Products">
	<META NAME="DocNumber" CONTENT="ESP-004-20001211">
</HEAD>
<BODY>

<H1 ALIGN="CENTER">Software Distribution<BR>
Using the<BR>
ESP Package Manager</H1>

<P ALIGN="CENTER">11 December 2000</P>

<P ALIGN="CENTER">Michael Sweet, Easy Software Products</P>

<P ALIGN="CENTER">ESP-004-20001211</P>

<H2>Contents</H2>

<UL>
	<LI><A HREF="#INTRO">Introduction</A>
	<LI><A HREF="#HISTORY">History and Evolution</A>
	<LI><A HREF="#EXISTING">Existing Software Packaging Systems</A>
	<LI><A HREF="#DESIGN">Design Goals of EPM</A>
	<LI><A HREF="#LIST">EPM List Files</A>
	<LI><A HREF="#BUILD">Building Distributions with EPM</A>
	<LI><A HREF="#READING">Further Reading</A>
	<LI><A HREF="#SUMMARY">Summary</A>
</UL>

<H2><A NAME="INTRO">Introduction</A></H2>

<P>Software distribution under UNIX/Linux can be a challenge,
especially if you ship software for more than one operating
system. Every operating system provides its own software
packaging tools and each has unique requirements or implications
for the software development environment.

<P>The ESP Package Manager ("EPM") is one solution to this
problem. Besides its own "portable" distribution format, EPM
also supports the generation of several vendor-specific formats.
This allows you to build software distribution files for almost
any UNIX/Linux operating system from the same sources.

<H2><A NAME="HISTORY">History and Evolution</A></H2>

<P>When Easy Software Products was founded in 1993, we
originally shipped software only for the SGI IRIX operating
system. In 1997 we added support for Solaris followed by HP-UX
support in 1998, each time building a new set of packaging files
for each operating system and supported processor. While this
worked, it also meant that we had to keep all of the packaging
files synchronized manually. Needless to say, this process was
far from perfect and we had more than one distribution that was
not identical on all operating systems.

<P>As we began developing the Common UNIX Printing System
("CUPS") in 1998, our goal was to add support for two additional
operating systems: Linux and Compaq Tru64 UNIX. Clearly we had
to change how we did software distributions.

<P>The first version of EPM was released in 1999 and supported
so-called "portable" software distributions that were not tied
to any particular operating system or packaging software. Due to
popular demand, we added support for specific packaging formats
in the second major release of EPM, allowing the generation of
portable or "native" distributions from one program.

<H2><A NAME="EXISTING">Existing Software Packaging Systems</A></H2>

<P>As we looked for a solution to our problem, we naturally
investigated the existing open-source packaging systems. Under
Linux, we looked at the RedHat Package Manager ("RPM") and
Debian packaging software ("dpkg" and "dselect").  For the
commercial UNIX's we looked at the vendor-supplied packaging
systems. The following table shows the results of our
investigation:

<P>
<TABLE ALIGN="CENTER" BORDER="1">
<TR>
	<TH><SMALL>Format</SMALL></TH>
	<TH><SMALL>Operating Systems<SUP>1</SUP></SMALL></TH>
	<TH><SMALL>Binaries?</SMALL></TH>
	<TH><SMALL>Cross- Platform?</SMALL></TH>
	<TH><SMALL>Patches?</SMALL></TH>
	<TH><SMALL>Upgrades?</SMALL></TH>
	<TH><SMALL>Conflicts?</SMALL></TH>
	<TH><SMALL>Requires?</SMALL></TH>
	<TH><SMALL>Replaces?</SMALL></TH>
	<TH><SMALL>Config Files?</SMALL></TH>
	<TH><SMALL>Map Files?</SMALL></TH>
</TR>
<TR>
	<TD>Debian</TD>
	<TD>Corel Linux<BR>
	Debian GNU/Linux</TD>
	<TD>Yes</TD>
	<TD>Yes<SUP>2</SUP></TD>
	<TD>No</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
	<TD>No</TD>
	<TD>Yes</TD>
	<TD>No</TD>
</TR>
<TR>
	<TD>depot</TD>
	<TD>HP-UX</TD>
	<TD>Yes</TD>
	<TD>No</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
	<TD>No</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
</TR>
<TR>
	<TD>inst</TD>
	<TD>IRIX</TD>
	<TD>Yes</TD>
	<TD>No</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
</TR>
<TR>
	<TD>pkg</TD>
	<TD>Solaris</TD>
	<TD>Yes</TD>
	<TD>No</TD>
	<TD>Yes</TD>
	<TD>No</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
	<TD>No</TD>
	<TD>No</TD>
	<TD>Yes</TD>
</TR>
<TR>
	<TD>RPM</TD>
	<TD>Mandrake<BR>
	RedHat<BR>
	SuSE<BR>
	TurboLinux</TD>
	<TD>Yes</TD>
	<TD>Yes<SUP>2</SUP></TD>
	<TD>No</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
	<TD>Yes</TD>
	<TD>No</TD>
	<TD>Yes</TD>
	<TD>No</TD>
</TR>
</TABLE>

<OL>

	<LI>Standard packaging system for named operating systems.

	<LI>These packaging systems are cross-platform but require
	the package management utilities to be installed on the
	platform before installing the package.

</OL>

<P>As you can see, none of the formats supported every feature
we were looking for. One common fault of all these formats is
that they do not support a common software specification file
format. That is, making a Debian software distribution requires
significantly different support files than required for a
Solaris pkg distribution. This makes it extremely difficult to
manage distributions for multiple operating systems.

<P>All of the package formats support binary distributions. The
RPM and Debian formats also support source distributions that
specifically allow for recompilation and installation. Only the
commercial UNIX formats support patch distributions - you have
to completely upgrade a software package with RPM and Debian.
All but the Solaris pkg format allow you to upgrade a package
without removing the old version first.

<P>When building the software packages, RPM and Debian force you
to create the actual directories, copy the files to those
directories, and set the ownerships and permissions. You
essentially are creating a directory for your software that can
be archived in the corresponding package format. To ensure that
all file permissions and ownerships are correct, you must build
the distribution as the root user, introducing potential
security risks and violating many corporate security policies.
It can also make building distributions difficult when dynamic
data such as changing data files or databases is involved.

<P>The commercial UNIX formats use software list files that map
source files to the correct directories and permissions.
This allows for easier delivery of dynamic data, configuration
management of what each distribution actually contains, and
eliminates security issues with special permissions and building
distributions as the root user. Using the proprietary format
also has the added benefit of allowing for software patches and
using the familiar software installation tools for that
operating system. The primary disadvantage is that the same
distributions and packaging software cannot be used on other
operating systems.

<H2><A NAME="DESIGN">Design Goals of EPM</A></H2>

<P>Our goals for the first release of EPM were fairly simple:

<OL>

	<LI>Build binary software distributions using a common
	software specification format. The same distribution
	files must work for all operating systems.

	<LI>Optionally strip executable files before packaging.

	<LI>Map source files and directories to the installation
	locations and permissions.

	<LI>Support configuration files and boot-time
	initialization scripts.

	<LI>Automatically backup existing files when a product
	replaces an existing file.

	<LI>Provide installation and removal scripts that will
	work on all systems without additional software.

	<LI>Support automatic upgrades to newer versions of a
	product using full or (smaller) patch distributions.

	<LI>Support software package conflicts, requirements,
	and replacements.

	<LI>Support network installations where
	<CODE>/usr</CODE> is shared amongst client machines.

	<LI>Make it all open-source under the GNU GPL.

</OL>

<P>For EPM 2.0 we added the following goals:

<OL>

	<LI>Support portable and vendor package formats from the
	same specification files. Make the interface easily
	extended to support new formats as they are implemented.

	<LI>Provide a simple GUI installer that can be included
	with portable distributions, like the popular
	InstallShield software in the Microsoft Windows world.

	<LI>Support variable substitution in filenames to allow
	for easier relocation and/or naming of files in the
	distribution.

	<LI>Support wildcards in source filenames.

</OL>

<P>As you can see, the focus has been on making the binary
software distribution process as easy as possible. Supporting
source code distributions was not a goal since most RPM and
Debian source distributions are little more than wrapping around
a compressed tar file containing the source files and a
configure script.

<H2><A NAME="LIST">EPM List Files</A></H2>

<P>EPM reads one or more software "list" files that describe a
single software package. Each list file contains one or more
lines of ASCII text containing product or file information.
Comments start with the <CODE>#</CODE> character.

<H3>Product Information</H3>

<P>The following is an excerpt from the EPM software list file
(<CODE>epm.list</CODE>) provided with the software:

<UL><PRE>
# Product information
%product ESP Package Manager
%copyright 1999-2000 by Easy Software Products, All Rights Reserved.
%vendor Easy Software Products
%license COPYING
%readme README
%description Universal software packaging tool for UNIX.
%version 2.2
</PRE></UL>

<P>As you can see, product information lines (as well as other
EPM directives) start with the percent (<CODE>%</CODE>)
character. The attribute name is followed by the value separated
by whitespace. 

<H3>Files</H3>

<P>Following the product information is the list of files to be
included in the distribution:

<UL><PRE>
# Executables
%system all
f 0555 root sys /usr/bin/epm epm
f 0555 root sys /usr/lib/epm/setup setup
f 0444 root sys /usr/share/doc/epm/README README
f 0444 root sys /usr/share/doc/epm/COPYING COPYING
f 0444 root sys /usr/share/doc/epm *.html

# Man pages
%system irix
f 0444 root sys /usr/share/catman/u_man/cat1/epm.1 epm.1
%system !irix
f 0444 root sys /usr/man/man1/epm.1 epm.man
</PRE></UL>

<P>The <CODE>%system</CODE> directive is one of two conditional
statements that can be included in software list files. In this
case we are installing the man pages in one of two directories
depending on the operating system.

<P>Plain files are indicated by the <CODE>f</CODE> at the
beginning of each line. Directories, configuration files,
initialization scripts, and symbolic links are specified using
the letters <CODE>d</CODE>, <CODE>c</CODE>, <CODE>i</CODE>, and
<CODE>l</CODE>, respectively. Files that should be included in a
patch upgrade use uppercase letters instead of lowercase.

<P>The remaining data fields on the line are the file permission
bits, the owner, the group, the destination filename, and the
source filename. The source and destination filenames can
contain references to environment variables and variables passed
on the EPM command-line. For example, the man page files can
reference the <CODE>mandir</CODE> variable to relocate the
installed man pages instead of using the <CODE>%system</CODE>
conditional directive:

<UL><PRE>
# Man pages
f 0444 root sys $mandir/cat1/epm.1 epm.1
f 0444 root sys $mandir/man1/epm.1 epm.man
</PRE></UL>

<P>As you can see, variables are referenced using the dollar
sign (<CODE>$</CODE>). As with most shells, variable names can
be surrounded by curly braces (<CODE>${variable}</CODE>) to
explicitly delimit the name.

<P>The source field can also use shell wildcards to include
multiple files on a single line:

<UL><PRE>
f 0444 root sys /usr/share/doc/epm *.html
</PRE></UL>

<H3>Directories</H3>

<P>Directories use a source file of <CODE>-</CODE>:

<UL><PRE>
d 0755 root sys /foo/bar/dir -
</PRE></UL>

<H3>Configuration Files</H3>

<P>Configuration files use the same format as regular files; if
the configuration file exists when the software is installed,
then the new configuration file is stored as
<CODE>filename.N</CODE> so it can be merged with the old
configuration file manually. This is one of the configuration
files supplied with the CUPS distribution:

<UL><PRE>
c 0644 root sys /etc/cups/cupsd.conf conf/cupsd.conf
</PRE></UL>

<H3>Intialization Scripts</H3>

<P>Initialization scripts are scripts or programs that are run
at boot time, usually to start daemon programs. EPM
automatically determines the location of initialization files at
install time, so it can handle the different locations used by
various Linux distributions. This is the initialization script
used by CUPS:

<UL><PRE>
i 0555 root sys cups cups.sh
</PRE></UL>

<P>This specifies that the root name of the initialization
script is <CODE>cups</CODE>, and the file <CODE>cups.sh</CODE>
should be used as the source for the script. EPM creates links
for startup and shutdown at run levels 0, 2, 3, and 5 as
appropriate.

<H3>Symbolic Links</H3>

<P>Symbolic links use the source field as the link value. That
is, if you want to provide a symbolic link from
<CODE>gzip</CODE> to <CODE>gunzip</CODE> in
<CODE>/usr/bin</CODE> you'd use:

<UL><PRE>
l 0555 root sys /usr/bin/gunzip gzip
</PRE></UL>

<H3>Conditional Directives</H3>

<P>As stated before, the <CODE>%system</CODE> directive can be used
to conditionally include specific files like the man pages in the EPM
distribution.

<P>The <CODE>%system</CODE> directive can match or not match
specific operating system names or versions. The operating
system name is the name reported by <CODE>uname</CODE> in
lowercase, while the operating system version is the major and
minor version number reported by <CODE>uname -r</CODE>:

<DL>

	<DT><CODE>%system irix</CODE>
	<DD>Only include the following files when building a distribution
	for the IRIX operating system.

	<DT><CODE>%system linux-2.0</CODE>
	<DD>Only include the following files when building a distribution
	for Linux 2.0.x.

	<DT><CODE>%system !irix !linux-2.0</CODE>
	<DD>Only include the following files when building a distribution
	for operating systems other than IRIX and Linux 2.0.x.

</DL>

<P>The special name <CODE>all</CODE> is used to match all operating systems:

<UL><PRE>
%system all
</PRE></UL>

<P>For format-specific files, the <CODE>%format</CODE> directive can be
used:

<DL>

	<DT><CODE>%format rpm</CODE>
	<DD>Only include the following files when building an RPM distribution.

	<DT><CODE>%format !rpm</CODE>
	<DD>Only include the following files when not building an RPM
	distribution.x.

	<DT><CODE>%format all</CODE>
	<DD>Include the following files for all types of distributions.

</DL>

<H3>Conflicts, Replaces, and Requires</H3>

<P>Software conflicts and requirements are specified using the
<CODE>%incompat</CODE> and <CODE>%requires</CODE> directives. If
your software replaces another package, you can specify that
using the <CODE>%replaces</CODE> directive (<CODE>%replaces</CODE>
is silently mapped to <CODE>%conflicts</CODE> when the distribution
format does not support package replacement.)

<P>Dependencies are specified using the package name:

<UL><PRE>
%requires foobar
%incompat foobar
%replaces foobar
</PRE></UL>

<P>or the filename:

<UL><PRE>
%requires /usr/lib/libfoobar.so
%incompat /usr/lib/libfoobar.so.1.2
</PRE></UL>

<P>Package dependencies are currently enforced only for the same
package format, so a portable distribution that requires package
"foobar" will only look for an installed "foobar" package in
portable format.

<P>Filename dependencies are only supported by the Debian,
portable, and RPM distribution formats.

<H2><A NAME="BUILD">Building Distributions with EPM</A></H2>

<P>To build a distribution called "epm" from this list file,
simply run:

<UL><PRE>
epm epm
</PRE></UL>

<P>EPM will automatically load the file <CODE>epm.list</CODE> for
the list file; to specify the file directly, use:

<UL><PRE>
epm epm epm.list
</PRE></UL>

<P>The first argument is the name of the package, while the
second is the list filename. The result will be a gzip'd tar
file containing the distribution files and installation script
needed to install the software.

<P>Variables are specified using using the equal sign (<CODE>=</CODE>);
there is no limit on the number of variables you can specify:

<UL><PRE>
epm mandir=/foo/bar/man epm epm.list
</PRE></UL>

<P>EPM can also produce vendor-specific distributions using the
<CODE>-f</CODE> option:

<UL><PRE>
epm -f format ...
</PRE></UL>

<P>The <I>format</I> option can be one of:

<UL>

	<LI><CODE>depot</CODE> or <CODE>swinstall</CODE> - HP-UX software
	distribution.

	<LI><CODE>dpkg</CODE> - Debian software distribution.

	<LI><CODE>inst</CODE> or <CODE>tardist</CODE> - IRIX software
	distribution.

	<LI><CODE>native</CODE> - "Native" software distribution (RPM,
	INST, DEPOT, PKG, etc.) for the platform.

	<LI><CODE>pkg</CODE> - Solaris software distribution.

	<LI><CODE>portable</CODE> - Portable software distribution (default).

	<LI><CODE>rpm</CODE> - RedHat software distribution.

</UL>

<P>Everything in the software list file stays the same - you just use the
<CODE>-f</CODE> option to select the format.  For example, to build an RPM
distribution of EPM, type:

<UL><PRE>
epm -f rpm epm
</PRE></UL>

<P>The result will be an RPM distribution file instead of the portable
distribution file.

<H2><A NAME="READING">Further Reading</A></H2>

<P>EPM supports several command-line options and many directives. For more
information see the EPM man page on-line with:

<UL><PRE>
man epm
</PRE></UL>

<P>You can also view the man page and other examples on-line at:

<UL><PRE>
<A HREF="http://www.easysw.com/epm/documentation.html">http://www.easysw.com/epm/documentation.html</A>
</PRE></UL>

<H2><A NAME="SUMMARY">Summary</A></H2>

<P>EPM provides a common interface to build binary software
distributions in a variety of formats. Since distributions are
built using the same software list file for all formats,
packages built using EPM likely will be more consistent across
platforms and will require less work to maintain. Since EPM is
designed to support multiple distribution formats, it can be
easily extended to support new formats, further reducing the
amount of work needed to support multiple platforms.

<P>Since EPM-generated portable and RPM distributions
automatically detect where initialization scripts should be
installed, EPM is especially useful for producing Linux software
packages that need to run under multiple Linux distributions.

<P>EPM is provided under the GNU General Public License. The EPM home
page is at:

<UL><PRE>
<A HREF="http://www.easysw.com/epm">http://www.easysw.com/epm</A>
</PRE></UL>

<P>Easy Software Products also provides commercial support for
EPM. Please consult the EPM home page for more information.

</BODY>
</HTML>
